\documentclass[handout, 12pt]{beamer}
%\documentclass[11pt]{beamer}

\input{preamble.tex}
\title[]{Latent Variable Methods for Batch Processes}
\subtitle[]{Learning from data}
\author[]{Instructor: Kevin Dunn \\{\tt kevin.dunn@connectmv.com}\\ http://connectmv.com}
\institute[]{}
\date[]{Course notes \copyright~ ConnectMV, Inc. \\ \vspace{1cm}{\footnotesize Presented at GSK, Mississauga, February 2011}}

\begin{document}
\begin{frame}
\titlepage
\end{frame}

\begin{frame}\frametitle{TODO}

	% \section{The final words}
	% 
	% \begin{frame}\frametitle{Final words}
	% 	\vspace{3pt}
	% 
	% 	{\color{myOrange}\bf The three main sources of errors are due to:}
	% 	\begin{enumerate}
	% 		\item {\bf The modeller:} model formulation errors
	% 		\item {\bf The algorithm:} truncation/discretization errors
	% 		\item {\bf The computer:} round-off errors
	% 	\end{enumerate}
	% 
	% 	\begin{columns}
	% 		\column{.80\textwidth}
	% 		\begin{exampleblock}{}
	% 			\centering{In engineering applications, use \alert{double-precision or better} to mitigate the effect of round-off error}
	% 		\end{exampleblock}
	% 	\end{columns}
	% 
	% 	\vspace{5pt}
	% 	\visible<2->{
	% 		\begin{columns}
	% 			\column{.34\textwidth}
	% 
	% 			\column{.65\textwidth}
	% 			\alert{\bf Reading:}\\
	% 			\vspace{3pt}
	% 			\begin{itemize}
	% 				\item Chapter 3 in S. C. Chapra, and R. P. Canale, {\em ``Numerical Methods for Engineers''}, McGraw Hill, 5th/6th Edition
	% 				\item Wikipedia article on \textbf{\texttt{Floating point}} is well-written
	% 				\item \href{http://docs.sun.com/source/806-3568/ncg_goldberg.html}{What every computer scientist should know about floating-point arithmetic}
	% 			\end{itemize}
	% 		\end{columns}
	% 	}
	% \end{frame}


\begin{itemize}
	\item	Adjust interline spacing  \hfill {\color{myOrange} $\leftarrow$ typical in practice!}
\end{itemize}
\end{frame}

\begin{frame}\frametitle{Interpreting score plots: \(t_1, t_2, \ldots \)}

\begin{itemize}
	\item	Shown as scatter plot or time-series plot

	\item	Each point in plot is an observation

	\item	\(t_1\) explains more than \(t_2\); i.e. pay more attention to lower scores

		\begin{itemize}
			\item	observations that are similar appear close together in all scores
			\item	\emph{colour code} score plots by another variables: makes plot more informative
		\end{itemize}

	\item	look for \textbf{clusters} and \textbf{patterns} to learn from data
\end{itemize}
\end{frame}

\begin{frame}\frametitle{Interpreting loading plots: \( p_1, p_2, \ldots \)}

\begin{itemize}
	\item	Shown as bar plots or scatter plots

	\item 	One point per variable in the model
	
		\begin{itemize}
			\item value of: \(\pm 0.8 vs \pm 0.6\) are both important
			\item value of: \(\pm 0.3 vs \pm 0.1\) are both quite small			
		\end{itemize}

	\item 	Each point in plot is an observation

	\item 	\(t_1\) explains more than \(t_2\); i.e. pay more attention to lower scores

		\begin{itemize}
			\item	observations that are similar appear close together in all scores
			\item 	\emph{colour code} score plots by another variables ] makes plot more informative
		\end{itemize}

	\item 	look for \textbf{clusters} and \textbf{patterns} to learn from data
\end{itemize}
\end{frame}

%-------------------------------------------------
\begin{frame}\frametitle{Outline}
\tableofcontents
\end{frame}
%-------------------------------------------------

%-------------------------------------------------
\section{What do we learn from our data?}
%-------------------------------------------------

\begin{frame}\frametitle{What do we learn from our data?}

\begin{enumerate}
	\item {\bf \color{myGreen}Improve/confirm} process understanding
	
		 How do we learn from our data?
\begin{itemize}

	\item	see which variables behave similarly (clustering) \pause
	\item	confirm which phenomena have greatest effect in the data 
	\begin{itemize}
		\item	high variability appears in first LVs
		\item	lower variability phenomena later
	\end{itemize}\pause

	\item	which variables have most strong influence on variability in that component
	\begin{itemize}
		\item variables with high loadings
	\end{itemize}\pause

	\item	interpret latent variables
	\begin{itemize}
		\item	sometimes we can
		\item	helps us when we think in latent variable space
	\end{itemize}
\end{itemize}
\end{enumerate}
\end{frame}

\begin{frame}\frametitle{What do we learn from our data?}

\begin{enumerate}
	\setcounter{enumi}{1}
	\item {\bf \color{myGreen}Troubleshooting}
	\begin{itemize}
		\item 	confirm a known problem occurred (SPE, \( T^2 \), \( t_a \))
		\item 	use contribution plots to diagnose
		\begin{itemize}
			\item 	what went wrong?
			\item 	when did it go wrong (batch)? 
		\end{itemize}\pause
		
		\item 	use interpretation of \( t_1, t_2 \) to explain high/low score values\pause
		\item 	use engineering judgement to fix problems from insight gained
	\end{itemize}
\end{enumerate}
\end{frame}
	
\begin{frame}\frametitle{What do we learn from our data?}

\begin{enumerate}
	\setcounter{enumi}{2}
	\item {\bf \color{myGreen}Improve/optimize} a process
	\begin{itemize}
		\item 	how can we move in the latent variable space?
		\item 	what are the causal variables to adjust to move in \( t_1, t_2, \ldots \)
		\item 	how do we do latent variable DOE's to fill in gaps
	\end{itemize}	
	These all rely on the concept of \alert{``model inversion''}
\end{enumerate}
\end{frame}

\begin{frame}\frametitle{What do we learn from our data?}

\begin{enumerate}
	\setcounter{enumi}{3}
	\item {\bf \color{myGreen}Predictive modelling} 
	\begin{itemize}
		\item 	rely on PLS models
		\item 	e.g. inferential sensors provide real-time prediction of \( \mathbf{Y} \), our final quality attributes
		\begin{itemize}
			\item 	PLS handles colinearity, missing values, noisy \( \mathbf{X} \)-variables
			\item 	these 3 issues cannot be dealt with in ordinary least squares
		\end{itemize}
	\end{itemize}	
\end{enumerate}
\end{frame}

\begin{frame}\frametitle{What do we learn from our data?}

\begin{enumerate}
	\setcounter{enumi}{4}
	\item {\bf \color{myGreen}Process monitoring} 
	\begin{itemize}
		\item 	build a model from ``in control'' operation: make sure we remain there
		\item 	don't need to take extra action if we remain in that space
		\item 	do adjust process if trending out of space; we have
		\begin{itemize}
			\item 	SPE, \( T^2 \) and \( t_a \) score limits to monitor against
		\end{itemize}
		
		\item 	use contribution plots to diagnose problems
	\end{itemize}	
\end{enumerate}
\end{frame}

\begin{frame}\frametitle{What do we learn from our data?}

\begin{enumerate}
	\setcounter{enumi}{4}
	\item 	{\bf \color{myGreen}Process monitoring} (cont'd)	

	\vspace{10pt}	
			Advantages over \emph{univariate} monitoring:
		
			\begin{itemize}
				\item 	we monitor \textbf{many} raw variables with summarized scores, SPE, and \( T^2 \)
				\item 	i.e. we actually have \emph{fewer} control charts with multivariate monitoring
				\item 	multivariate charts interpreted in the same way as univariate charts
				\item 	i.e. no extra operator training required
				\item 	ordinary Shewhart charts do not give any help with diagnosis
			\end{itemize}	
\end{enumerate}
\end{frame}

\begin{frame}\frametitle{Tools to learn from our data}

\begin{enumerate}
	\item 	\alert{Generic}: applicable to all types of processes
	\item 	\alert{Informative}: easy to use by untrained staff for decision making
		\begin{itemize}
			\item clear and quick action possible
		\end{itemize}
	\item 	\alert{Simple to implement}: straightforward calculations and fast
\end{enumerate}

\vspace{1cm}

\begin{exampleblock}{}<2->
\centering{\large{\color{myOrange} Latent variable methods meet these criteria}}
\end{exampleblock}
\end{frame}

%-------------------------------------------------
\section{General multivariate review}
%-------------------------------------------------

STILL TO COME

%-------------------------------------------------
\section{Batch systems}
%-------------------------------------------------
% Related concepts: phases, Z, trajectories, alignment, recipes, operators, manual steps, unfolding, charge reactor

\begin{frame}\frametitle{Batch systems: concepts and unique features}

\begin{itemize}
	\item 	Start point, an end point, and time-based evolution of tags (variables) in between
	
	\item 	Operate essentially in open-loop i.t.o. final quality attributes (FQAs).  Basic, low-level feedback. \pause
	
	\item 	Quality measurements made afterwards, usually in a lab
	
			\begin{itemize}
				\item	used to decide batch disposition
				\item	often used to adjust next batch (batch-to-batch control)
			\end{itemize}\pause
			
	\item	Sequenced very accurately
	
	\item	Phase-based sequencing \pause

\end{itemize}
\end{frame}

\begin{frame}\frametitle{Batch systems: concepts and unique features}

\begin{itemize}
	

	\item	Nonlinear relationship between variables; relationship changes with time
	
	\item	Poor mechanistic models available (understandable)
	
			\begin{itemize}
				\item	continuous: one or two things happening all the time
				\item	batch: series of phases/events and relationships differ between (and within!) phases
			\end{itemize}
			
	\item 	Past history within a batch affects the future
	
			\begin{itemize}
				\item	initial conditions: affect trajectories and FQAs								
				\item	trajectory changes from operator affect FQAs
				\item	actions taken can affect some period or all of batch, or,
				\item	even have no effect - relevant when monitoring a batch
			\end{itemize}
\end{itemize}
\end{frame}

\begin{frame}\frametitle{Batch systems: data representation (Excel, MATLAB)}
	TODO
\end{frame}

\begin{frame}\frametitle{Batch systems: simple definition}

\begin{exampleblock}{Simplest definition}
\centering{\large{\textbf{A batch system}: group of the \alert{\emph{same variables}}, gathered over a period of \alert{\emph{time}}}}
\end{exampleblock}
	
\todo{1. image of batch reactor system (Cecilia thesis?)}

\end{frame}	

\begin{frame}\frametitle{Batch systems: changing relationship}

\textbf{Batch system}: group of the \emph{same variables}, gathered over a period of \emph{time}.  Why not just use ordinary PCA or PLS as shown here?

\todo{2. add ordinary X-matrix}

\begin{itemize}
	\item 	PCA is invariant to row order (can shuffle rows, still get same model).  PCA will:
	\begin{itemize}
		\item 	explain how rows are related to each other
		\item 	each row is assumed independent of the others
		\item 	summarize relationship between variables (columns)
	\end{itemize}
\end{itemize}

\begin{exampleblock}{Key issue}
In \textbf{batch systems}: relationship between variables \alert{changes during the batch}
\end{exampleblock}
\end{frame}

\begin{frame}\frametitle{Batch systems: changing relationship}

\begin{enumerate}
	\item Relationship between variables change within a batch 
			\begin{itemize}
				\item 	Entry and exit temperatures in a batch dryer correlate (move together) at the end of the batch. 
				\item 	At start of the batch there is little relationship: heat used to evaporate moisture	
			\end{itemize}\pause

	
	\item Past history of a batch affects future behaviour (``integrating system'')
	
			\begin{itemize}
				\item 	Unfold batch data as shown above: cannot capture that ``past effect'' on future rows.  Why?
				\item  	Recall: each row is independent in PCA and PLS
			\end{itemize}

\end{enumerate}
\end{frame}

\begin{frame}\frametitle{Batch systems: changing relationship}

\begin{enumerate}
	\setcounter{enumi}{2}
	\item 	Predictive modelling is harder

		\todo{3. figure of batch with uncertain Y}
		
		\begin{itemize}
			\item 	What do we use as the \( \mathbf{Y} \) matrix in this case?
			\item 	Many elaborate schemes proposed in literature.			
		\end{itemize}
		
	\item 	Simple solution: arrange data so that each batch is within a row
	
			\begin{itemize}
				\item 	There are some issues with this  (alignment, real-time monitoring)
				\item 	In general, they can be addressed effectively
			\end{itemize}
\end{enumerate}
\end{frame}



%-------------------------------------------------
\section{Batch analysis using feature extraction}
%-------------------------------------------------

STILL TO COME

%-------------------------------------------------
\section{Batch analysis via direct PCA and PLS}
%-------------------------------------------------

\begin{frame}\frametitle{LVM for batch processes: terminology}

\begin{description} 
	
	\item[\color{myGreen}{\textbf{Lack of stability}}] 
	
		\begin{itemize}
			\item	Reference data (phase I) is representative of normal operation
			
			\item	but if process has shifted too much, monitoring will raise too many false alarms.
			
			\item	If something major has changed: acquire new data and rebuild model.
		\end{itemize}
		
	\item[\color{myGreen}{\textbf{Unobservable events}}] 
	
		\begin{itemize}
			\item Events you want to detect must be \emph{detectable} in the raw data.
		
			\item	Not all quality-related problems are observable in the data.
		\end{itemize}
		
\end{description}
\end{frame}
%-------------------------------------------------
\section{Batch Monitoring}
%-------------------------------------------------

\begin{frame}\frametitle{Batch monitoring overview}

\begin{enumerate}
	\item 	Univariate process monitoring recap
	
	\item	Multivariate process monitoring recap
	
	\item	Batch monitoring
	
		\begin{itemize}
			\item	feature-based monitoring			
			\item	building the monitoring model for real-time use (selecting phase I data)
			\item	monitoring for acceptance / end-of-batch release
			\item	endpoint detection monitoring
			\item	multiblock monitoring: using information in \( Z \)			
			\item	alignment issues
			\item 	When does LVM monitoring fail?
		\end{itemize}
\end{enumerate}
\end{frame}

\begin{frame}\frametitle{Multiblock monitoring: what goes in \( Z \)?}

\begin{block}{}
Any relevant information that is constant over the batch 
\end{block}

\begin{itemize}
	\item	feed stock quality and composition (your lab values, supplier's spec sheet)	
	\item	idle time between phases / initial setup time
	\item	summary information of upstream operations
			\begin{itemize}
				\item	averages				
				\item	latent variable summary: scores
			\end{itemize}
	\item	desired recipe	
	\item	alignment information from \( \mathbf{X}_\text{batch} \)
	\item	operator or shift information (coded)
	\item	day of batch, month (e.g. can show a seasonal effect)
	\item	raw material supplier (coded)
	\item	properties in batch tank after adding material: pH, NIR spectra, colour, temperature
	\item	ambient conditions: temperature, humidity, and so on
\end{itemize}
\end{frame}

\begin{frame}\frametitle{When does LVM monitoring fail?}

\begin{description} 
	
	\item[\color{myGreen}{\textbf{Lack of stability}}] 
	
		\begin{itemize}
			\item	Reference data (phase I) is representative of normal operation
			
			\item	but if process has shifted too much, monitoring will raise too many false alarms.
			
			\item	If something major has changed: acquire new data and rebuild model.
		\end{itemize}
		
	\item[\color{myGreen}{\textbf{Unobservable events}}] 
	
		\begin{itemize}
			\item Events you want to detect must be \emph{detectable} in the raw data.
		
			\item	Not all quality-related problems are observable in the data.
		\end{itemize}
		
\end{description}
\end{frame}

%-------------------------------------------------
\section{Summary so far}
%-------------------------------------------------

\begin{frame}\frametitle{Value from batch process data}
\begin{enumerate}
	\item 	Learning more / confirming relationships
		
			\begin{itemize}
				\item 	understand between batch variation (overall scores, \( T^2 \), and SPE)
				\item 	understand within batch variation (instantaneous scores, \( T^2 \), and SPE)
			\end{itemize}
			
	\item 	Troubleshoot problems within a batch
	\item 	Optimize and improve: possible, but less likely in pharmaceutical applications
	\item 	Predictions: final quality attributes, endpoint
	\item 	Monitoring: can allow for early release to next stage
	
\end{enumerate}
\end{frame}



\end{document}

